# app/Home.py
# --- path guard ---
import sys, pathlib
ROOT = pathlib.Path(__file__).resolve().parents[1]
if str(ROOT) not in sys.path:
    sys.path.insert(0, str(ROOT))
# -------------------

import streamlit as st
from pathlib import Path

# ‚ö†Ô∏è PRIMER comando de Streamlit:
st.set_page_config(
    page_title="REX-AI Mars ‚Äî Mission Hub",
    page_icon="üõ∞Ô∏è",
    layout="wide"
)

# ---------- Estilos SpaceX-like ----------
st.markdown("""
<style>
:root{ --bd: rgba(130,140,160,.28);}
.hero{
  border:1px solid var(--bd);
  border-radius:22px;
  padding:28px;
  margin-bottom:20px;
  background: radial-gradient(1200px 400px at 20% -20%, rgba(80,120,255,.12), transparent);
}
.hero h1{margin:0 0 6px 0; font-size:2rem}
.hero .tagline{font-size:1.1rem; opacity:.9; margin-bottom:12px}
.grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:18px; margin:20px 0;}
.card{border:1px solid var(--bd); border-radius:16px; padding:18px; background:rgba(255,255,255,.02);}
.card h3{margin:.1rem 0 .25rem 0;}
.kpi{border:1px solid var(--bd); border-radius:14px; padding:14px; text-align:center;}
.kpi h3{margin:0 0 6px 0; font-size:.95rem; opacity:.8}
.kpi .v{font-size:1.6rem; font-weight:800; letter-spacing:.2px}
.pill{display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; font-size:.78rem;
      border:1px solid var(--bd); margin-right:6px}
.pill.ok{background:#e8f7ee; color:#136c3a; border-color:#b3e2c4}
.pill.info{background:#e7f1ff; color:#174ea6; border-color:#c6dcff}
.pill.warn{background:#fff3cd; color:#8a6d1d; border-color:#ffe69b}
.small{font-size:.92rem; opacity:.9}
.section{margin-top:30px; margin-bottom:18px;}
.section h2{margin-bottom:6px;}
</style>
""", unsafe_allow_html=True)

# ---------- Encabezado ----------
logo_svg = ROOT / "app" / "static" / "logo_rexai.svg"
cols = st.columns([0.15, 0.85])
with cols[0]:
    if logo_svg.exists():
        st.image(str(logo_svg), use_column_width=True)
with cols[1]:
    st.title("REX-AI Mars ‚Äî Mission Hub")
    st.caption("Recycling & Experimentation eXpert ‚Äî Jezero Base")

# ---------- Hero narrative ----------
st.markdown("""
<div class="hero">
  <h1>Conoce a REX-AI</h1>
  <div class="tagline">
    Nuestra inteligencia artificial que convierte basura espacial en recursos para la misi√≥n.
  </div>
  <div>
    <span class="pill info">Reciclaje inteligente</span>
    <span class="pill ok">Optimizaci√≥n multi-objetivo</span>
    <span class="pill warn">Uso seguro de MGS-1</span>
  </div>
</div>
""", unsafe_allow_html=True)

# ---------- Qu√© hace (versi√≥n narrativa + t√©cnica) ----------
st.markdown("### ¬øQu√© hace REX-AI?")
st.markdown("""
**En criollo**:  
La nave genera **basura inorg√°nica** ‚Äî pouches multicapa, espumas, textiles, guantes de nitrilo, piezas de aluminio.  
Lo que hace **REX-AI** es agarrar ese l√≠o y decirte: *‚ÄúCon esto pod√©s armar un contenedor, un utensilio, una herramienta‚Ä¶‚Äù*  
Y no lo hace a ojo: combina datos reales de procesos, costos de crew, y hasta regula la mezcla con **regolito MGS-1** del cr√°ter Jezero.

**Para ingenieros**:  
- Analiza inventarios reales (NASA Non-Metabolic Waste Categories).  
- Selecciona procesos viables (Shredder, Heat Lamination, Sinter con MGS-1, Reuso CTB).  
- Calcula propiedades predichas (rigidez, estanqueidad, masa final) con modelos ligeros.  
- Punt√∫a cada candidato con un **score multi-objetivo**: compatibilidad con target + penalizaci√≥n por recursos + bonus por ‚Äúconsumir problem√°ticos‚Äù.  
- Devuelve recetas con trazabilidad: cada ID, categor√≠a y flag queda registrado.
""")

# ---------- Estado del sistema ----------
st.markdown("### Estado actual")
c1, c2, c3, c4 = st.columns(4)
data_ok = (ROOT / "data" / "waste_inventory_sample.csv").exists()
proc_ok = (ROOT / "data" / "process_catalog.csv").exists()
tgt_ok  = (ROOT / "data" / "targets_presets.json").exists()
with c1: st.markdown(f'<div class="kpi"><h3>Inventario</h3><div class="v">{"‚úÖ" if data_ok else "‚ùå"}</div></div>', unsafe_allow_html=True)
with c2: st.markdown(f'<div class="kpi"><h3>Procesos</h3><div class="v">{"‚úÖ" if proc_ok else "‚ùå"}</div></div>', unsafe_allow_html=True)
with c3: st.markdown(f'<div class="kpi"><h3>Targets</h3><div class="v">{"‚úÖ" if tgt_ok else "‚ùå"}</div></div>', unsafe_allow_html=True)
with c4: st.markdown('<div class="kpi"><h3>Modo</h3><div class="v">Demo</div></div>', unsafe_allow_html=True)

# ---------- Flujo ----------
st.markdown("### Flujo de misi√≥n")
st.markdown("""
<div class="grid">
  <div class="card"><h3>1) Inventario</h3><div class="small">Sub√≠ y edit√° los residuos. Detectamos los **problem√°ticos** y los marcamos.</div></div>
  <div class="card"><h3>2) Objetivo</h3><div class="small">Defin√≠ qu√© quer√©s fabricar (ej: Container, Tool) y l√≠mites de recursos.</div></div>
  <div class="card"><h3>3) Generador</h3><div class="small">REX-AI arma recetas priorizando consumir problem√°ticos y elige procesos coherentes.</div></div>
  <div class="card"><h3>4) Resultados</h3><div class="small">Ves m√©tricas, trade-offs, Sankey de flujo y checklist de fabricaci√≥n.</div></div>
</div>
""", unsafe_allow_html=True)

# ---------- Explicaci√≥n SpaceX-style ----------
st.markdown("### ¬øPor qu√© importa?")
st.markdown("""
- **Nivel crew**: cada minuto de astronauta ahorrado vale millones. REX-AI aprende a minimizarlo.  
- **Nivel recursos**: el agua y energ√≠a en Marte son como oro; penalizamos cualquier exceso.  
- **Nivel materiales**: en lugar de mandar toneladas desde la Tierra, reusamos lo que ya est√° en el h√°bitat.  
- **Nivel misi√≥n**: m√°s seguridad (sin incineraci√≥n, sin PFAS), m√°s resiliencia (aprovechar regolito local).  

**Ejemplo simple**:  
Si mezclamos espuma ZOTEK F30 con regolito MGS-1 ‚Üí se logra un panel r√≠gido que puede reforzar interiores.  
Si usamos pouches multicapa en laminar + presi√≥n ‚Üí conseguimos l√°minas estancas para compartimentos.  
""")

# ---------- Ruta completa ----------
st.markdown("---")
st.caption(
    "Ruta: 1) Inventario ‚Üí 2) Objetivo ‚Üí 3) Generador ‚Üí 4) Resultados ‚Üí "
    "5) Comparar ‚Üí 6) Pareto & Export ‚Üí 7) Playbooks ‚Üí 8) Feedback & Impact ‚Üí 9) Capacity Simulator"
)

# === Extensi√≥n: Escalabilidad & Roadmap t√©cnico (SpaceX-style) ===

st.markdown("## Escalabilidad y Roadmap t√©cnico ‚Äî c√≥mo REX-AI crece sin techo üöÄ")

st.markdown("""
**Resumen ejecutivo**  
REX-AI hoy es una **demo operativa** con m√≥dulos ligeros y trazabilidad real (IDs de residuo, categor√≠as, flags y uso de MGS-1).  
Fue dise√±ada como **esqueleto escalable**: los mismos puntos de extensi√≥n que hoy alimentan el generador pueden acoplarse a
pipelines de datos, modelos avanzados y orquestaci√≥n industrial sin reescribir la app.  
**Meta**: convertir la basura en *supply chain in-situ*, con IA que aprende en cada corrida y reduce agua/energ√≠a/tiempo/costo.

### 1) Estado actual (v1 demo)
- **Arquitectura modular**: `app/modules/*` separa UI, IO, generador, scoring, explicabilidad y export.
- **Trazabilidad**: cada candidato guarda `source_ids`, `source_categories`, `source_flags` y `regolith_pct`.
- **Compatibilidad de datos**: normalizaci√≥n robusta (nombres de columna variables), enfoque *schema-first* simple.
- **Explicabilidad**: score multi-objetivo transparente + desglose por componentes (funci√≥n, agua, energ√≠a, crew, seguridad).
- **Seguridad**: reglas ‚Äúhard-stop‚Äù (sin incineraci√≥n, evitar PFAS/micropl√°sticos), y checks de coherencia b√°sica por proceso.

### 2) Arquitectura para escalar (c√≥mo se vuelve cada vez m√°s inteligente)
**Plano de datos (Data Plane)**
- **Ingesta**: CSV/JSON hoy ‚Üí **Parquet** en **objeto/MinIO** o **S3**, versi√≥n de datos por corrida (data lineage).
- **Contratos de datos**: `pydantic`/`msgspec` para validar lotes, procesos y targets (rompe si no cumple -> evitar ‚Äúdata drift‚Äù).
- **Cat√°logo**: `PostgreSQL/pgvector` para b√∫squedas sem√°nticas de materiales/flags y `DuckDB` para an√°lisis *in-process*.
- **Streaming**: `Kafka/Redpanda` para telemetr√≠a de ensayos (tiempo real) y bit√°coras de procesos (IoT/OPC-UA/ROS puenteados).

**Plano de modelos (Model Plane)**
- **Surrogates de propiedades**: de ‚Äúheur√≠sticas ligeras‚Äù ‚Üí a **GNNs** (material graphs), **XGBoost/TabTransformer** (tabular),
  y **Physics-Informed ML** (PIML) para rigidez/porosidad/estanqueidad condicionadas al proceso.
- **Incertidumbre**: **ensembles**, **MC Dropout**, **conformal prediction** ‚Üí graficar bandas de confianza y *risk-aware scoring*.
- **Optimizaci√≥n**: **Bayesian Optimization** (Ax/BoTorch) para receta/proceso bajo l√≠mites (agua/kWh/crew),
  m√°s **solvers con restricciones** (MILP/CP-SAT) para factibilidad operativa (turnos, kg/lote, disponibilidad).
- **Ciclo activo**: **Active Learning** y **Bayesian Experimental Design** que selecciona el *pr√≥ximo experimento* de mayor valor.

**Plano de control (Control Plane)**
- **MLOps**: entrenamiento/registro con **MLflow** o **Weights & Biases**, versionado de datasets y de artefactos.
- **Orquestaci√≥n**: **Airflow/Prefect** para pipelines de ingesta, feature store, entrenamiento y despliegue continuo (CD).
- **Serving**: **FastAPI** + **ONNX Runtime/TensorRT** para inferencia acelerada (CPU/GPU/Jetson), cola con **Redis**.
- **Edge/Flight**: empaquetado **OCI** con perfiles reproducibles (SBOM), estrategia *graceful degradation* y *circuit breakers*.

### 3) Seguridad, fiabilidad y compliance (misi√≥n cr√≠tica)
- **Guardrails de proceso**: pol√≠ticas *deny-by-default* para incineraci√≥n y sustancias cr√≠ticas; whitelists por h√°bitat.
- **Provenance**: hash de datasets y modelos, **audit log** por corrida, exportables a JSON/CSV (ya presente en demo).
- **Testing y validaci√≥n**: *golden datasets*, *shadow mode* para nuevos modelos, *canary releases* y *rollbacks* at√≥micos.
- **Resiliencia**: timeouts, reintento exponencial para ingestas/sens√≥rica, *data gap filling* y *late data handling*.

### 4) Interoperabilidad con infraestructura de misi√≥n
- **Protocolos**: OPC-UA/ROS para c√©lulas rob√≥ticas, **ISA-95/88** para integraci√≥n MES/SCADA.
- **Digital Twin**: simulaci√≥n *in-silico* (DEM/FEM simplificada) para priorizar ensayos con mayor valor esperado.
- **Compatibilidad NASA**: mapeo a taxonom√≠as *Non-Metabolic Waste*, ingenier√≠a de materiales (MGS-1) y formatos est√°ndar.

### 5) ¬øPor qu√© puede revolucionar Marte y la Tierra?
- **Marte (ISRU real)**: convertir *lo que sobra* en *lo que falta* con costo marginal casi nulo en log√≠stica interplanetaria.
- **Tierra (econom√≠a circular)**: recetas trasladables a residuos complejos (multicapa/espumas), cierre de ciclos en bases remotas,
  miner√≠a urbana y descarbonizaci√≥n por **reducci√≥n de materia virgen + energ√≠a**.
- **Aprendizaje compuesto**: cada base/h√°bitat entrena un pedacito ‚Üí federado, con privacidad y *model averaging*.

### 6) Roadmap por etapas (claro y accionable)
**T-0 (demo+)**  
- Persistir corridas en DuckDB/Parquet, MLflow local, bandas de confianza visuales, export de *experiment design*.

**T-1 (MVP productivo)**  
- FastAPI + ONNX serving, BO con restricciones, pgvector para materiales, Airflow para pipelines diarios, auditor√≠a completa.

**T-2 (Flight-ready)**  
- Edge GPU (TensorRT), active learning en lazo cerrado, integraci√≥n OPC-UA/ROS, digital twin ligero y canary en campo.

**T-3 (Programa)**  
- Federated learning entre h√°bitats, planificaci√≥n multi-planta, optimizaci√≥n global de recursos y log√≠stica inversa.

### 7) C√≥mo REX-AI se ‚Äúvuelve m√°s inteligente‚Äù (de verdad)
1. **Captura** datos crudos de cada corrida (input ‚Üí receta ‚Üí proceso ‚Üí salida).  
2. **Valida** con contratos de datos y los guarda versionados.  
3. **Etiqueta/Enriquece** (features, contexto, condiciones de proceso).  
4. **Re-entrena** surrogates con incertidumbre y compara vs. ‚Äúgolden‚Äù.  
5. **Optimiza** pr√≥ximos experimentos (m√≠nimo costo, m√°ximo aprendizaje).  
6. **Despliega** modelos certificados; deja bit√°cora y *rollbacks*.  
7. **Repite** (cada ciclo reduce agua/kWh/crew y mejora score/seguridad).

> **Mensaje al jurado**: lo que hoy ves corriendo en Streamlit ya implementa trazabilidad, reglas y explicabilidad.
> Cambiar de ‚Äúheur√≠sticas‚Äù a **modelos avanzados** es un swap controlado en `modules/generator.py` y `modules/explain.py`,
> con el resto de la arquitectura (datos/MLOps/serving) ya preparada para crecer sin romper la UX ni la seguridad.
""")
